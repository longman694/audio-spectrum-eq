<!DOCTYPE html>
<html class="sl-theme-dark">
    <head>
        <title>Spectral Analysis + Polar Vectorscope</title>
        <style>
            body {
                color: #EEEEEE;
                background-color: #030303;
                font-family: sans-serif;
            }
            #control-container {
                width: 100%;
                display: flex;
                align-items: center;
                margin-top: 10px;
            }
            #audio-container {
                flex-grow: 1;
                margin-right: 0.2em;
            }
            #audio-container audio {
                width: 100%;
            }
            #container {
                background-color: #111111;
                margin-left: 255px;
                margin-right: 20px;
                height: 400px;
                position: relative;
                border-radius: 8px;
                overflow: hidden;
            }
            #vectorscope-container {
                display: flex;
                flex-direction: column;
                align-items: center;
                margin-top: 20px;
                margin-bottom: 20px;
            }
            canvas#vectorscope {
                background-color: #000;
                border: 1px solid #333;
                border-radius: 400px 400px 0 0; /* Semi-circle */
                box-shadow: 0 0 20px rgba(0, 255, 255, 0.1);
                /* Size */
                width: 800px; 
                height: 400px;
            }
            .center { text-align: center; }
            .phase-guide {
                position: absolute;
                top: 350px; 
                width: 800px;
                display: flex;
                justify-content: space-between;
                padding: 0 80px;
                font-size: 0.9em;
                color: #555;
                pointer-events: none;
            }
        </style>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.15.0/cdn/themes/dark.css" />
        <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.15.0/cdn/shoelace-autoloader.js"></script>
    </head>
    <body>
        <div id="container">
            <div id="notice" style="padding: 20px;">
                <label for="btn_start">Select audio a file</label> <input id="btn_start" type="file" />
            </div>
        </div>
        <div id="control-container">
            <div id="audio-container"></div>
            <sl-button variant="default" size="large" style="display: none;" id="btn_destroy" circle>
                <sl-icon name="x-lg" label="Settings"></sl-icon>
            </sl-button>
        </div>
        <div id="message" class="box center"></div>

        <sl-tab-group>
            <sl-tab slot="nav" panel="eq">EQ</sl-tab>
            <sl-tab slot="nav" panel="analysis">Analysis</sl-tab>

            <sl-tab-panel name="eq">
                <div style="margin-top: 10px;">
                    <weq8-ui />
                </div>
            </sl-tab-panel>

            <sl-tab-panel name="analysis">
                <div id="vectorscope-container" style="position: relative; width: 800px; margin: 20px auto;">
                    <h3 style="margin: 0 0 10px 0; color: #888; text-align: center;">Polar Level</h3>
                    <canvas id="vectorscope" width="800" height="400"></canvas>
                    <div class="phase-guide">
                        <span>L</span><span>Mono</span><span>R</span>
                    </div>
                </div>
            </sl-tab-panel>
        </sl-tab-group>

        <div class="center">more <a href="https://audiomotion.dev/#/" target="_blank">settings</a></div>

        <script type="module">
            import AudioMotionAnalyzer from 'https://cdn.skypack.dev/audiomotion-analyzer?min';
            import { WEQ8Runtime } from "https://cdn.skypack.dev/weq8";
            import "https://cdn.skypack.dev/weq8/ui";
    
            const container       = document.getElementById('container'),
                  audioContainer = document.getElementById('audio-container'),
                  destroyButton  = document.getElementById('btn_destroy'),
                  startButton    = document.getElementById('btn_start'),
                  messageDiv      = document.getElementById('message'),
                  noticeDiv       = document.getElementById('notice'),
                  canvasVS        = document.getElementById('vectorscope');
    
            destroyButton.addEventListener( 'click', destroy );
            startButton.addEventListener( 'change', initialize );
    
            let audioEl, audioMotion, source, weq8;
            let audioContext;
            
            // --- VECTORSCOPE VARIABLES ---
            let vsCtx, vsAnimationId;
            let tapSource = null;

            // Define the Bands
            const bands = [
                { name: 'sub', max: 32 },
                { name: 'sub', min: 32, max: 63 },
                { name: 'low', min: 63, max: 88 },
                { name: 'low', min: 88, max: 125 },
                { name: 'low-mid', min: 125, max: 176 },
                { name: 'low-mid', min: 176, max: 250 },
                { name: 'mid', min: 250, max: 353 },
                { name: 'mid', min: 353, max: 500 },
                { name: 'mid-high', min: 500, max: 707 },
                { name: 'mid-high', min: 707, max: 1000 },
                { name: 'high', min: 1000, max: 1414 },
                { name: 'high', min: 1414, max: 2000 },
                { name: 'presence', min: 2000, max: 2828 },
                { name: 'presence', min: 2828, max: 4000 },
                { name: 'brilliance', min: 4000, max: 5656 },
                { name: 'brilliance', min: 5656, max: 8000 },
                { name: 'upper', min: 8000, max: 11313 },
                { name: 'upper', min: 11313, max: 16000 },
                { name: 'air', min: 16000 }
            ];
            
            // Arrays to hold the Web Audio nodes for each band
            let bandNodes = []; 

            const numAngleBins = 120; 
            
            // Layer 1: The Decay Envelope (Cyan)
            let decayBins = new Float32Array(numAngleBins).fill(0);
            const envelopeDecay = 0.92; 
            
            // Layer 2: The History Peak (White)
            const historyLimit = 120; // 2 seconds
            let historyBins = []; 

            function initialize() {
                vsCtx = canvasVS.getContext('2d');

                var file = this.files[0]
                var blob = window.URL || window.webkitURL;
                if (!blob) { console.log('No Blob URL support'); return; }
                var fileURL = blob.createObjectURL(file);

                audioEl = new Audio(fileURL);
                audioEl.controls = true;
                audioEl.crossOrigin = 'anonymous';
                audioEl.onloadstart  = () => messageDiv.innerText = 'Buffering...';
                audioEl.onloadeddata = () => {
                    messageDiv.innerText = '';
                    audioEl.play();
                    drawVectorscope(); 
                }
                
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                source = audioContext.createMediaElementSource(audioEl);
                weq8 = new WEQ8Runtime(audioContext);
                
                audioMotion = new AudioMotionAnalyzer( container, {
                    audioCtx: audioContext, connectSpeakers: false, frequencyScale: 'log',
                    minFreq: 10, maxFreq: 24000, gradient: 'prism', mode: 0,
                    ansiBands: true, smoothing: 0.4, channelLayout: 'dual-vertical',
                });

                // --- ROUTING ---
                source.connect(weq8.input);
                audioMotion.connectInput(weq8);
                audioMotion.connectOutput(audioContext.destination);

                // Tap signal for Vectorscope
                if (audioMotion.analyzer) {
                     tapSource = audioMotion.analyzer;
                } else {
                     tapSource = weq8;
                }
                
                // --- BUILD PARALLEL FILTER BANK ---
                // We create a separate path for each band:
                // Tap -> Filter(s) -> Splitter -> AnalyserL/R
                
                // Clear old nodes if any
                bandNodes = [];

                bands.forEach(band => {
                    // 1. Create Filter Chain
                    let inputNode, outputNode;
                    
                    if (!band.min) { // Lowpass only (Sub)
                        const lp = audioContext.createBiquadFilter();
                        lp.type = 'lowpass';
                        lp.frequency.value = band.max;
                        inputNode = lp; outputNode = lp;
                    } else if (!band.max) { // Highpass only (Air)
                        const hp = audioContext.createBiquadFilter();
                        hp.type = 'highpass';
                        hp.frequency.value = band.min;
                        inputNode = hp; outputNode = hp;
                    } else { // Bandpass (HP + LP)
                        const hp = audioContext.createBiquadFilter();
                        hp.type = 'highpass';
                        hp.frequency.value = band.min;
                        
                        const lp = audioContext.createBiquadFilter();
                        lp.type = 'lowpass';
                        lp.frequency.value = band.max;
                        
                        hp.connect(lp);
                        inputNode = hp; outputNode = lp;
                    }
                    
                    // 2. Create Splitter & Analysers
                    const split = audioContext.createChannelSplitter(2);
                    const anL = audioContext.createAnalyser();
                    const anR = audioContext.createAnalyser();
                    anL.fftSize = 2048; 
                    anR.fftSize = 2048;
                    
                    // 3. Connect Chain
                    tapSource.connect(inputNode);
                    outputNode.connect(split);
                    split.connect(anL, 0);
                    split.connect(anR, 1);
                    
                    // 4. Store for Analysis Loop
                    bandNodes.push({
                        l: anL,
                        r: anR,
                        // Pre-allocate buffers for performance
                        dataL: new Uint8Array(anL.frequencyBinCount),
                        dataR: new Uint8Array(anR.frequencyBinCount)
                    });
                });

                document.querySelector("weq8-ui").runtime = weq8;
                audioContainer.append( audioEl );
                noticeDiv.style.display = 'none';
                destroyButton.style.display = 'block';
            }


            // --- DRAWING LOGIC ---
            function drawVectorscope() {
                if(bandNodes.length === 0 || !vsCtx) return;

                const width = canvasVS.width;
                const height = canvasVS.height;
                const bufferLength = bandNodes[0].l.frequencyBinCount;

                // This will hold the maximum magnitude for each angle across ALL bands
                let compositeFrameBins = new Float32Array(numAngleBins).fill(0);

                // --- 1. ANALYZE ALL BANDS ---
                // We loop through every band, calculate its shape, and merge it into compositeFrameBins
                for (let b = 0; b < bandNodes.length; b++) {
                    const node = bandNodes[b];
                    
                    node.l.getByteTimeDomainData(node.dataL);
                    node.r.getByteTimeDomainData(node.dataR);
                    
                    // Optimization: Skip loop if band is silent? 
                    // Hard to detect cheaply without looping, so we just loop.
                    // We step by 8 to save CPU since we have 10 bands now.
                    for (let i = 0; i < bufferLength; i += 8) {
                        const absL = Math.abs((node.dataL[i] / 128.0) - 1.0);
                        const absR = Math.abs((node.dataR[i] / 128.0) - 1.0);
                        const sum = absL + absR;
                        
                        if (sum < 0.01) continue; 

                        const currentMag = Math.max(absL, absR); 
                        const stereoPos = absR / sum; 

                        let binIndex = Math.floor(stereoPos * (numAngleBins - 1));
                        binIndex = Math.max(0, Math.min(numAngleBins-1, binIndex));

                        // MAX MERGE:
                        // If this specific band is louder at this specific angle 
                        // than what we've seen in other bands, use this value.
                        if (currentMag > compositeFrameBins[binIndex]) {
                             compositeFrameBins[binIndex] = currentMag;
                        }
                    }
                }

                // --- 2. Update Decay (Cyan Line) ---
                for (let i = 0; i < numAngleBins; i++) {
                    decayBins[i] *= envelopeDecay; 
                    if (compositeFrameBins[i] > decayBins[i]) {
                        decayBins[i] = compositeFrameBins[i]; 
                    }
                }

                // --- 3. Update History (White Line) ---
                historyBins.push(compositeFrameBins); // Push the raw composite
                if (historyBins.length > historyLimit) {
                    historyBins.shift(); 
                }
                
                // Calculate Max over History
                let maxWindowBins = new Float32Array(numAngleBins).fill(0);
                for (let h = 0; h < historyBins.length; h++) {
                    const frame = historyBins[h];
                    for (let b = 0; b < numAngleBins; b++) {
                        if (frame[b] > maxWindowBins[b]) {
                            maxWindowBins[b] = frame[b];
                        }
                    }
                }

                // --- 4. Draw ---
                vsCtx.clearRect(0,0, width, height);
                vsCtx.fillStyle = '#050505';
                vsCtx.fillRect(0,0,width,height);

                drawGuideLines(width, height);

                function drawOutline(bins, color, widthVal, fillStyle) {
                    const centerX = width / 2;
                    const bottomY = height - 5; 
                    const maxRadius = Math.min(width / 2, height) * 0.95;

                    vsCtx.beginPath();
                    vsCtx.moveTo(centerX, bottomY); 

                    for (let i = 0; i < numAngleBins; i++) {
                        let magnitude = Math.pow(bins[i], 0.7);
                        const baseRadius = 5; 
                        const finalRadius = baseRadius + (magnitude * (maxRadius - baseRadius));
                        const percent = i / (numAngleBins - 1);
                        const angleRad = 2.356 - (percent * (2.356 - 0.785));
                        const drawX = centerX + (Math.cos(angleRad) * finalRadius);
                        const drawY = bottomY - (Math.sin(angleRad) * finalRadius);
                        vsCtx.lineTo(drawX, drawY);
                    }
                    
                    vsCtx.lineTo(centerX, bottomY); 
                    vsCtx.closePath();

                    if(fillStyle) {
                        vsCtx.fillStyle = fillStyle;
                        vsCtx.fill();
                    }
                    vsCtx.lineWidth = widthVal;
                    vsCtx.strokeStyle = color;
                    vsCtx.stroke();
                }

                // Draw Max Window (Back Layer) - White/Ghost
                drawOutline(maxWindowBins, 'rgba(255, 255, 255, 0.4)', 1, null);

                // Draw Decay (Front Layer) - Cyan
                drawOutline(decayBins, '#00ccff', 2, 'rgba(0, 204, 255, 0.15)');

                vsAnimationId = requestAnimationFrame(drawVectorscope);
            }

            function drawGuideLines(w, h) {
                vsCtx.strokeStyle = 'rgba(255, 255, 255, 0.15)';
                vsCtx.lineWidth = 1;
                const cx = w/2;
                const by = h-5;
                const r = Math.min(w/2, h) * 0.95;
                vsCtx.beginPath();
                vsCtx.moveTo(cx, by); vsCtx.lineTo(cx + Math.cos(2.356)*r, by - Math.sin(2.356)*r);
                vsCtx.moveTo(cx, by); vsCtx.lineTo(cx + Math.cos(0.785)*r, by - Math.sin(0.785)*r);
                vsCtx.moveTo(cx, by); vsCtx.lineTo(cx, by - r);
                vsCtx.stroke();
            }
    
            function destroy() {
                if(vsAnimationId) cancelAnimationFrame(vsAnimationId);
                audioEl.pause(); 
                audioEl.remove(); 
                audioMotion.destroy();
                historyBins = [];
                bandNodes = []; // Clear refs
                audioMotion = null; 
                audioEl = null;
                noticeDiv.style.display = 'flex'; 
                destroyButton.style.display = 'none';
            }
        </script>
    </body>
</html>