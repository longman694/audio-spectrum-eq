<!DOCTYPE html>
<html class="sl-theme-dark">
    <head>
        <title>Spectral Analysis + Polar Vectorscope</title>
        <style>
            body {
                color: #EEEEEE;
                background-color: #030303;
                font-family: sans-serif;
            }
            #control-container {
                width: 100%;
                display: flex;
                align-items: center;
                margin-top: 10px;
            }
            #audio-container {
                flex-grow: 1;
                margin-right: 0.2em;
            }
            #audio-container audio {
                width: 100%;
            }
            #container {
                background-color: #111111;
                margin-left: 255px;
                margin-right: 20px;
                height: 400px;
                position: relative;
                border-radius: 8px;
                overflow: hidden;
            }
            #vectorscope-container {
                display: flex;
                flex-direction: column;
                align-items: center;
                margin-top: 20px;
                margin-bottom: 20px;
            }
            canvas#vectorscope {
                background-color: #000;
                border: 1px solid #333;
                border-radius: 400px 400px 0 0; /* Semi-circle */
                box-shadow: 0 0 20px rgba(0, 255, 255, 0.1);
                /* Size */
                width: 800px; 
                height: 400px;
            }
            .center { text-align: center; }
            .phase-guide {
                position: absolute;
                top: 350px; 
                width: 800px;
                display: flex;
                justify-content: space-between;
                padding: 0 80px;
                font-size: 0.9em;
                color: #555;
                pointer-events: none;
            }
        </style>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.15.0/cdn/themes/dark.css" />
        <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.15.0/cdn/shoelace-autoloader.js"></script>
    </head>
    <body>
        <div id="container">
            <div id="notice" style="padding: 20px;">
                <label for="btn_start">Select audio a file</label> <input id="btn_start" type="file" />
            </div>
        </div>
        <div id="control-container">
            <div id="audio-container"></div>
            <sl-button variant="default" size="large" style="display: none;" id="btn_destroy" circle>
                <sl-icon name="x-lg" label="Settings"></sl-icon>
            </sl-button>
        </div>
        <div id="message" class="box center"></div>

        <sl-tab-group>
            <sl-tab slot="nav" panel="eq">EQ</sl-tab>
            <sl-tab slot="nav" panel="analysis">Analysis</sl-tab>

            <sl-tab-panel name="eq">
                <div style="margin-top: 10px;">
                    <weq8-ui />
                </div>
            </sl-tab-panel>

            <sl-tab-panel name="analysis">
                <div id="vectorscope-container" style="position: relative; width: 800px; margin: 20px auto;">
                    <h3 style="margin: 0 0 10px 0; color: #888; text-align: center;">Polar Level</h3>
                    <canvas id="vectorscope" width="800" height="400"></canvas>
                    <div class="phase-guide">
                        <span>L</span><span>Mono</span><span>R</span>
                    </div>
                </div>
            </sl-tab-panel>
        </sl-tab-group>

        <div class="center">more <a href="https://audiomotion.dev/#/" target="_blank">settings</a></div>

        <script type="module">
            import AudioMotionAnalyzer from 'https://cdn.skypack.dev/audiomotion-analyzer?min';
            import { WEQ8Runtime } from "https://cdn.skypack.dev/weq8";
            import "https://cdn.skypack.dev/weq8/ui";
    
            const container       = document.getElementById('container'),
                  audioContainer = document.getElementById('audio-container'),
                  destroyButton  = document.getElementById('btn_destroy'),
                  startButton    = document.getElementById('btn_start'),
                  messageDiv      = document.getElementById('message'),
                  noticeDiv       = document.getElementById('notice'),
                  canvasVS        = document.getElementById('vectorscope');
    
            destroyButton.addEventListener( 'click', destroy );
            startButton.addEventListener( 'change', initialize );
    
            let audioEl, audioMotion, source, weq8;
            
            // --- VECTORSCOPE VARIABLES ---
            let vsCtx, splitter, analyserL, analyserR, vsAnimationId;
            const numAngleBins = 120; 
            
            // System 1: Decay (The cyan active line)
            let decayBins = new Float32Array(numAngleBins).fill(0);
            const envelopeDecay = 0.92; // Adjust for responsiveness
            
            // System 2: History (The white max hold line)
            const historyLimit = 120; // 2 seconds at 60fps
            let historyBins = []; 

            function initialize() {
                vsCtx = canvasVS.getContext('2d');

                var file = this.files[0]
                var blob = window.URL || window.webkitURL;
                if (!blob) { console.log('No Blob URL support'); return; }
                var fileURL = blob.createObjectURL(file);

                audioEl = new Audio(fileURL);
                audioEl.controls = true;
                audioEl.crossOrigin = 'anonymous';
                audioEl.onloadstart  = () => messageDiv.innerText = 'Buffering...';
                audioEl.onloadeddata = () => {
                    messageDiv.innerText = '';
                    audioEl.play();
                    drawVectorscope(); 
                }
                
                var context = new (window.AudioContext || window.webkitAudioContext)();
                source = context.createMediaElementSource(audioEl);
                weq8 = new WEQ8Runtime(context);
                
                audioMotion = new AudioMotionAnalyzer( container, {
                    audioCtx: context, connectSpeakers: false, frequencyScale: 'log',
                    minFreq: 10, maxFreq: 24000, gradient: 'prism', mode: 0,
                    ansiBands: true, smoothing: 0.4, channelLayout: 'dual-vertical',
                });

                splitter = context.createChannelSplitter(2);
                analyserL = context.createAnalyser();
                analyserR = context.createAnalyser();
                analyserL.fftSize = 2048; 
                analyserR.fftSize = 2048;

                source.connect(weq8.input);
                audioMotion.connectInput(weq8);
                audioMotion.connectOutput(context.destination);

                if (audioMotion.analyzer) {
                     audioMotion.analyzer.connect(splitter);
                } else {
                     weq8.connect(splitter);
                }
                
                splitter.connect(analyserL, 0);
                splitter.connect(analyserR, 1);

                document.querySelector("weq8-ui").runtime = weq8;
                audioContainer.append( audioEl );
                noticeDiv.style.display = 'none';
                destroyButton.style.display = 'block';
            }

            // --- DRAWING LOGIC ---
            function drawVectorscope() {
                if(!analyserL || !analyserR || !vsCtx) return;

                const width = canvasVS.width;
                const height = canvasVS.height;
                const bufferLength = analyserL.frequencyBinCount;
                const dataL = new Uint8Array(bufferLength);
                const dataR = new Uint8Array(bufferLength);

                analyserL.getByteTimeDomainData(dataL);
                analyserR.getByteTimeDomainData(dataR);

                // --- 1. Calculate Current Frame ---
                let currentFrameBins = new Float32Array(numAngleBins).fill(0);

                for (let i = 0; i < bufferLength; i += 4) {
                    const absL = Math.abs((dataL[i] / 128.0) - 1.0);
                    const absR = Math.abs((dataR[i] / 128.0) - 1.0);
                    const sum = absL + absR;
                    if (sum < 0.01) continue; 

                    const currentMag = sum / 2; 
                    const stereoPos = absR / sum; 

                    let binIndex = Math.floor(stereoPos * (numAngleBins - 1));
                    binIndex = Math.max(0, Math.min(numAngleBins-1, binIndex));

                    if (currentMag > currentFrameBins[binIndex]) {
                         currentFrameBins[binIndex] = currentMag;
                    }
                }

                // --- 2. Update Decay System ---
                for (let i = 0; i < numAngleBins; i++) {
                    decayBins[i] *= envelopeDecay; // Shrink
                    if (currentFrameBins[i] > decayBins[i]) {
                        decayBins[i] = currentFrameBins[i]; // Push up
                    }
                }

                // --- 3. Update History System ---
                historyBins.push(currentFrameBins);
                if (historyBins.length > historyLimit) {
                    historyBins.shift(); 
                }
                
                // Find Max over History
                let maxWindowBins = new Float32Array(numAngleBins).fill(0);
                for (let h = 0; h < historyBins.length; h++) {
                    const frame = historyBins[h];
                    for (let b = 0; b < numAngleBins; b++) {
                        if (frame[b] > maxWindowBins[b]) {
                            maxWindowBins[b] = frame[b];
                        }
                    }
                }

                // --- 4. Draw ---
                vsCtx.clearRect(0,0, width, height);
                vsCtx.fillStyle = '#050505';
                vsCtx.fillRect(0,0,width,height);

                drawGuideLines(width, height);

                // Helper to draw a shape
                function drawOutline(bins, color, widthVal, fillStyle) {
                    const centerX = width / 2;
                    const bottomY = height - 5; 
                    const maxRadius = Math.min(width / 2, height) * 0.95;

                    vsCtx.beginPath();
                    vsCtx.moveTo(centerX, bottomY); 

                    for (let i = 0; i < numAngleBins; i++) {
                        let magnitude = Math.pow(bins[i], 0.7);
                        const baseRadius = 5; 
                        const finalRadius = baseRadius + (magnitude * (maxRadius - baseRadius));
                        const percent = i / (numAngleBins - 1);
                        const angleRad = 2.356 - (percent * (2.356 - 0.785));
                        const drawX = centerX + (Math.cos(angleRad) * finalRadius);
                        const drawY = bottomY - (Math.sin(angleRad) * finalRadius);
                        vsCtx.lineTo(drawX, drawY);
                    }
                    
                    vsCtx.lineTo(centerX, bottomY); 
                    vsCtx.closePath();

                    if(fillStyle) {
                        vsCtx.fillStyle = fillStyle;
                        vsCtx.fill();
                    }
                    vsCtx.lineWidth = widthVal;
                    vsCtx.strokeStyle = color;
                    vsCtx.stroke();
                }

                // Draw Max Window (Back Layer) - Color: White/Ghost
                drawOutline(maxWindowBins, 'rgba(255, 255, 255, 0.4)', 1, null);

                // Draw Decay (Front Layer) - Color: Cyan
                drawOutline(decayBins, '#00ccff', 2, 'rgba(0, 204, 255, 0.15)');

                vsAnimationId = requestAnimationFrame(drawVectorscope);
            }

            function drawGuideLines(w, h) {
                vsCtx.strokeStyle = 'rgba(255, 255, 255, 0.15)';
                vsCtx.lineWidth = 1;
                const cx = w/2;
                const by = h-5;
                const r = Math.min(w/2, h) * 0.95;
                vsCtx.beginPath();
                vsCtx.moveTo(cx, by); vsCtx.lineTo(cx + Math.cos(2.356)*r, by - Math.sin(2.356)*r);
                vsCtx.moveTo(cx, by); vsCtx.lineTo(cx + Math.cos(0.785)*r, by - Math.sin(0.785)*r);
                vsCtx.moveTo(cx, by); vsCtx.lineTo(cx, by - r);
                vsCtx.stroke();
            }
    
            function destroy() {
                if(vsAnimationId) cancelAnimationFrame(vsAnimationId);
                audioEl.pause(); 
                audioEl.remove(); 
                audioMotion.destroy();
                historyBins = [];
                audioMotion = null; 
                audioEl = null;
                noticeDiv.style.display = 'flex'; 
                destroyButton.style.display = 'none';
            }
        </script>
    </body>
</html>